"use strict";(self.webpackChunkblog_johnnyreilly_com=self.webpackChunkblog_johnnyreilly_com||[]).push([[68394],{3905:(e,t,n)=>{n.d(t,{Zo:()=>u,kt:()=>h});var a=n(67294);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function r(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function l(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var s=a.createContext({}),p=function(e){var t=a.useContext(s),n=t;return e&&(n="function"==typeof e?e(t):r(r({},t),e)),n},u=function(e){var t=p(e.components);return a.createElement(s.Provider,{value:t},e.children)},d={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},c=a.forwardRef((function(e,t){var n=e.components,i=e.mdxType,o=e.originalType,s=e.parentName,u=l(e,["components","mdxType","originalType","parentName"]),c=p(n),h=i,m=c["".concat(s,".").concat(h)]||c[h]||d[h]||o;return n?a.createElement(m,r(r({ref:t},u),{},{components:n})):a.createElement(m,r({ref:t},u))}));function h(e,t){var n=arguments,i=t&&t.mdxType;if("string"==typeof e||i){var o=n.length,r=new Array(o);r[0]=c;var l={};for(var s in t)hasOwnProperty.call(t,s)&&(l[s]=t[s]);l.originalType=e,l.mdxType="string"==typeof e?e:i,r[1]=l;for(var p=2;p<o;p++)r[p]=n[p];return a.createElement.apply(null,r)}return a.createElement.apply(null,n)}c.displayName="MDXCreateElement"},49963:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>p,contentTitle:()=>l,default:()=>c,frontMatter:()=>r,metadata:()=>s,toc:()=>u});n(67294);var a=n(3905);function i(){return i=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a])}return e},i.apply(this,arguments)}function o(e,t){if(null==e)return{};var n,a,i=function(e,t){if(null==e)return{};var n,a,i={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(i[n]=e[n]);return i}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}const r={title:"Get Build Validations with the Azure DevOps API",authors:"johnnyreilly",tags:["Azure Pipelines","Azure DevOps API"],image:"./title-image.png",hide_table_of_contents:!1},l=void 0,s={permalink:"/2022/07/10/azure-devops-api-build-validations",editUrl:"https://github.com/johnnyreilly/blog.johnnyreilly.com/edit/main/blog-website/blog/2022-07-10-azure-devops-api-build-validations/index.md",source:"@site/blog/2022-07-10-azure-devops-api-build-validations/index.md",title:"Get Build Validations with the Azure DevOps API",description:"Build validations are a great way to protect your branches in Azure DevOps. It's possible to use the Azure DevOps API to acquire the build validations a project uses. This post shows you how using curl and the Node.js API.",date:"2022-07-10T00:00:00.000Z",formattedDate:"July 10, 2022",tags:[{label:"Azure Pipelines",permalink:"/tags/azure-pipelines"},{label:"Azure DevOps API",permalink:"/tags/azure-dev-ops-api"}],readingTime:3.43,hasTruncateMarker:!1,authors:[{name:"John Reilly",url:"https://twitter.com/johnny_reilly",imageURL:"https://blog.johnnyreilly.com/img/profile.jpg",key:"johnnyreilly"}],frontMatter:{title:"Get Build Validations with the Azure DevOps API",authors:"johnnyreilly",tags:["Azure Pipelines","Azure DevOps API"],image:"./title-image.png",hide_table_of_contents:!1},prevItem:{title:"Terry Pratchett and the Azure Static Web Apps",permalink:"/2022/07/23/terry-pratchett-x-clacks-overhead-azure-static-webapps"},nextItem:{title:"Azure Static Web Apps: Failed to deploy the Azure Functions",permalink:"/2022/07/07/static-web-apps-failed-to-deploy-the-azure-functions"}},p={image:n(70963).Z,authorsImageUrls:[void 0]},u=[{value:"Build validations",id:"build-validations",level:2},{value:"curl build validations",id:"curl-build-validations",level:2},{value:"Node.js API",id:"nodejs-api",level:2},{value:"Conclusion",id:"conclusion",level:2}],d={toc:u};function c(e){var{components:t}=e,r=o(e,["components"]);return(0,a.kt)("wrapper",i({},d,r,{components:t,mdxType:"MDXLayout"}),(0,a.kt)("p",null,"Build validations are a great way to protect your branches in Azure DevOps. It's possible to use the Azure DevOps API to acquire the build validations a project uses. This post shows you how using curl and the Node.js API."),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"title image reading &quot;Get Build Validations with the Azure DevOps API&quot; with Azure Pipelines and Azure DevOps logo",src:n(70963).Z,width:"1080",height:"1080"})),(0,a.kt)("h2",i({},{id:"build-validations"}),"Build validations"),(0,a.kt)("p",null,"We care about our ",(0,a.kt)("inlineCode",{parentName:"p"},"main")," branch. Before changes can be made to it, we want them to meet some kind of quality benchmark. In Azure DevOps these come in the form of branch policies. We're interested in a particular type of these called ",(0,a.kt)("a",i({parentName:"p"},{href:"https://docs.microsoft.com/en-us/azure/devops/repos/git/branch-policies?view=azure-devops&tabs=browser#build-validation"}),"build validations"),":"),(0,a.kt)("blockquote",null,(0,a.kt)("p",{parentName:"blockquote"},"A build validation policy queues a new build when a new PR is created or changes are pushed to an existing PR that targets the branch. The build policy evaluates the build results to determine whether the PR can be completed.")),(0,a.kt)("p",null,"If you want to examine whether a project uses build validations, you can do so using the Azure DevOps API. It's available under the ",(0,a.kt)("a",i({parentName:"p"},{href:"https://docs.microsoft.com/en-us/rest/api/azure/devops/policy/configurations/list?view=azure-devops-rest-7.1"}),"policy configurations endpoint"),"."),(0,a.kt)("h2",i({},{id:"curl-build-validations"}),"curl build validations"),(0,a.kt)("p",null,"To acquire build validations from the API we'll need a personal access token. We can make one of those here: ",(0,a.kt)("a",i({parentName:"p"},{href:"https://dev.azure.com/organisation-name/_usersSettings/tokens"}),"https://dev.azure.com/organisation-name/_usersSettings/tokens")," (where ",(0,a.kt)("inlineCode",{parentName:"p"},"organisation-name")," is the name of our organisation)."),(0,a.kt)("p",null,"With that in hand, let's acquire the branch policies with a ",(0,a.kt)("a",i({parentName:"p"},{href:"https://curl.se/"}),"curl"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",i({parentName:"pre"},{className:"language-bash"}),"curl  --user '':'PERSONAL_ACCESS_TOKEN' --header \"Content-Type: application/json\" --header \"Accept:application/json\" https://dev.azure.com/{organisation}/{project}/_apis/policy/configurations?api-version=7.1-preview.1\n")),(0,a.kt)("p",null,"You'll retrieve a JSON array that represents all the branch policies that are in play, ",(0,a.kt)("em",{parentName:"p"},"including")," build validations. Below is an example of a retrieved build validation:"),(0,a.kt)("pre",null,(0,a.kt)("code",i({parentName:"pre"},{className:"language-json"}),'[\n  //...\n  {\n    "createdBy": {\n      "displayName": "Project Collection Build Service (organisation-name)",\n      "url": "https://spsprodweu1.vssps.visualstudio.com/A2426c3ce-09b0-4333-9218-58da7d53c564/_apis/Identities/aad5a5e5-baf9-40b3-ad30-0cb828c25629",\n      "_links": {\n        "avatar": {\n          "href": "https://dev.azure.com/organisation-name/_apis/GraphProfile/MemberAvatars/svc.MjQyNmMzY2UtMDliMC00MzMzLTkyMTgtNThkYTdkNTNjNTY0OkJ1aWxkOmE1YTE3N2U2LTZhMzAtNGRiMi1iYzMxLTllOTE1M2U3Yjk0Nw"\n        }\n      },\n      "id": "aad5a5e5-baf9-40b3-ad30-0cb828c25629",\n      "uniqueName": "Build\\\\a5a177e6-6a30-4db2-bc31-9e9153e7b947",\n      "imageUrl": "https://dev.azure.com/organisation-name/_api/_common/identityImage?id=aad5a5e5-baf9-40b3-ad30-0cb828c25629",\n      "descriptor": "svc.MjQyNmMzY2UtMDliMC00MzMzLTkyMTgtNThkYTdkNTNjNTY0OkJ1aWxkOmE1YTE3N2U2LTZhMzAtNGRiMi1iYzMxLTllOTE1M2U3Yjk0Nw"\n    },\n    "createdDate": "2022-07-06T14:25:39.5585302Z",\n    "isEnabled": true,\n    "isBlocking": true,\n    "isDeleted": false,\n    "settings": {\n      "buildDefinitionId": 1107,\n      "queueOnSourceUpdateOnly": true,\n      "manualQueueOnly": false,\n      "displayName": "PR Validation",\n      "validDuration": 720,\n      "scope": [\n        {\n          "refName": "refs/heads/main",\n          "matchKind": "Exact",\n          "repositoryId": "dc4213a0-fc26-4afc-8b3e-4fd27eaaafa6"\n        }\n      ]\n    },\n    "isEnterpriseManaged": false,\n    "_links": {\n      "self": {\n        "href": "https://dev.azure.com/organisation-name/ea861f16-ec9d-4256-a2a6-55dd7533af36/_apis/policy/configurations/1261"\n      },\n      "policyType": {\n        "href": "https://dev.azure.com/organisation-name/ea861f16-ec9d-4256-a2a6-55dd7533af36/_apis/policy/types/0609b952-1397-4640-95ec-e00a01b2c241"\n      }\n    },\n    "revision": 2,\n    "id": 1261,\n    "url": "https://dev.azure.com/organisation-name/ea861f16-ec9d-4256-a2a6-55dd7533af36/_apis/policy/configurations/1261",\n    "type": {\n      "id": "0609b952-1397-4640-95ec-e00a01b2c241",\n      "url": "https://dev.azure.com/organisation-name/ea861f16-ec9d-4256-a2a6-55dd7533af36/_apis/policy/types/0609b952-1397-4640-95ec-e00a01b2c241",\n      "displayName": "Build"\n    }\n  }\n]\n')),(0,a.kt)("p",null,"Note the ",(0,a.kt)("inlineCode",{parentName:"p"},"type")," property with the ",(0,a.kt)("inlineCode",{parentName:"p"},"displayName")," of ",(0,a.kt)("inlineCode",{parentName:"p"},'"Build"'),". That's how we identify build validations in amongst the other branch policies. If you'd like to filter the output down to just build validations on the command line, you can by mixing your curl with a little ",(0,a.kt)("a",i({parentName:"p"},{href:"https://stedolan.github.io/jq/"}),"jq"),":"),(0,a.kt)("pre",null,(0,a.kt)("code",i({parentName:"pre"},{className:"language-bash"}),"curl  --user '':'PERSONAL_ACCESS_TOKEN' --header \"Content-Type: application/json\" --header \"Accept:application/json\" https://dev.azure.com/{organisation}/{project}/_apis/policy/configurations?api-version=7.1-preview.1 | jq -c '.value[] | select(.type.displayName == \"Build\")'\n")),(0,a.kt)("h2",i({},{id:"nodejs-api"}),"Node.js API"),(0,a.kt)("p",null,"If you'd like to achieve the same using TypeScript, you can. The ",(0,a.kt)("a",i({parentName:"p"},{href:"https://github.com/microsoft/azure-devops-node-api"}),"Azure DevOps Client for Node.js")," provides an API and (in large part) the types. Let's obtain the build validations for a project in Node.js using the client:"),(0,a.kt)("pre",null,(0,a.kt)("code",i({parentName:"pre"},{className:"language-ts"}),"import * as nodeApi from 'azure-devops-node-api';\n\ninterface BuildValidation {\n  buildDefinitionId: number | undefined;\n  name: string | undefined;\n  repositoryId: string | undefined;\n}\n\nasync function getProjectBuildValidations(\n  projectId: string\n): Promise<BuildValidation[]> {\n  const authHandler = nodeApi.getPersonalAccessTokenHandler(\n    pat,\n    /** allowCrossOriginAuthentication */ true\n  );\n\n  const webApi = new nodeApi.WebApi(orgUrl, authHandler);\n  const policyApi = await webApi.getPolicyApi();\n\n  const configurations = await policyApi.getPolicyConfigurations(projectId);\n\n  const buildValidations = configurations\n    .filter(\n      // we only want the build validations\n      (configuration) => configuration.type?.displayName === 'Build'\n    )\n    .map((configuration) => ({\n      // map down to a custom type\n      buildDefinitionId: configuration.settings.buildDefinitionId,\n      name: configuration.settings.displayName,\n      repositoryId:\n        configuration.settings.scope?.length > 0\n          ? configuration.settings.scope[0].repositoryId\n          : undefined,\n    }));\n\n  return buildValidations;\n}\n")),(0,a.kt)("p",null,"The above ",(0,a.kt)("inlineCode",{parentName:"p"},"getProjectBuildValidations")," function acquires build validations for a given project, and maps them into this custom type:"),(0,a.kt)("pre",null,(0,a.kt)("code",i({parentName:"pre"},{className:"language-ts"}),"interface BuildValidation {\n  /** the id of the azure pipeline which is triggered by the build validation */\n  buildDefinitionId: number | undefined;\n  /** the name of the build validation */\n  name: string | undefined;\n  /** if a build validation is tied to a repository (probable) this is the repository id */\n  repositoryId: string | undefined;\n}\n")),(0,a.kt)("p",null,"Which leaves us with a delightfully strongly typed array of build validations!"),(0,a.kt)("h2",i({},{id:"conclusion"}),"Conclusion"),(0,a.kt)("p",null,"This post has detailed what build validations are in Azure DevOps. It has also demonstrated how to query the Azure DevOps API for them using the command line and using Node.js."))}c.isMDXComponent=!0},70963:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/title-image-f73e7c9a5db1270af6e9e8fe22260b5f.png"}}]);